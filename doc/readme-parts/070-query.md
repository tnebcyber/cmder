

## **Designing Queries in FluentCMS**
<details> <summary> FluentCMS streamlines frontend development with support for GraphQL-style queries. </summary>

### Requirements

#### 1. Retrieve all related data with one API call
As shown in the screenshot below, we aim to design a course detail page. In addition to displaying basic course information, 
the page should also show related entity data, such as:
- Teacher's bio and skills
- Course-related materials, such as videos   
![Course](https://raw.githubusercontent.com/fluent-cms/fluent-cms/doc/doc/screenshots/page-course.png)
#### 2. Filter data by related entity
In the example below, when displaying a skill, we want to show which teachers have that skill and the courses they teach. 
The tables involved include `courses`, `teachers`, `teacher-skill` (the cross referencing table), and `skills`.
![Related](https://raw.githubusercontent.com/fluent-cms/fluent-cms/doc/doc/screenshots/page-related.png)

### Query Settings
To create or edit a query, navigate to `Schema Builder` > `Queries`.  
![Query](https://raw.githubusercontent.com/fluent-cms/fluent-cms/doc/doc/screenshots/query-setting.png)

### Query Structure
To understand the structure of a FluentCMS query, consider the SQL generated by FluentCMS below, with `course` as the primary entity:

- `teacher` is a lookup attribute of the course.
- `skills` is a cross-table attribute of teacher.


```
 SELECT DISTINCT "courses"."name", "courses"."id", "courses"."desc", "courses"."image", "courses"."summary", "courses"."level", "courses"."status", "courses"."teacher" 
   from "courses" 
      left join "teachers" as "teacher" on "courses"."teacher" = "teacher"."id"
      left join "skill_teacher" as "skills_skill_teacher" on "teacher"."id" = "teacher_skills_skill_teacher"."teacher_id"
      left join "skills" as "teacher_skills" on "teacher_skills_skill_teacher"."skill_id" = "teacher_skills"."id" 
 WHERE "courses"."deleted" = 0 AND "teacher"."deleted" = 0 AND "teacher_skills_skill_teacher"."deleted" = 0 AND "teacher_skills"."deleted" = 0 
  AND ("teacher_skills"."id" IN (1)) 
 ORDER BY "courses"."id" 
 DESC LIMIT 20
```

#### 1. Selection Set
The Selection Set specifies which columns to retrieve. You can include columns from the main entity as well as `lookup` and `crosstable` entities.
```graphql
{
    id,
    name,
    desc,
    image,
    level,
    status,
    teacher{
        firstname,
        lastname,
        image,
        bio,
        skills{
            name,
            years
        }
    },
    materials{
        name,
        image,
        link
    }
}
```

#### 2. From Entity
Each query is based on a main Entity,  setting the main entity's table name as `From` clause.
#### 3. Limit
The query's `Page Size` property sets to `Limit clause`.
#### 4. Sorts
Sorts define the `order by` clause. Sorting can be applied to the main entity or related entities, e.g., below settings corresponds to:

```
select * from course left join teachers 
  on course.teacher = teachers.id
  order by teacher.firstname asc, course.id desc
```

```json
{
  "sorts": [
    {
      "fieldName": "teacher.firstname",
      "order": "Asc"
    },
    {
      "fieldName": "id",
      "order": "Desc"
    }
  ]
}
```

#### 5. Filter
Filter settings define the `WHERE` clause to control which data is retrieved.
- **fieldName**: Specifies a column in either the main entity or a related entity.
- **operator**: `and` requires all constraints to match, while `or` matches any single constraint.
- **constraints**:
  - **match**: Defines how to match values, such as `in` or `startWith`.
  - **value**: Can be hardcoded within the query or passed as a query string parameter.   
  For example, `qs.course_id` pulls the ID from the query string parameter `course_id`, where the prefix `qs.` indicates that the value comes from the query string.  
  Example API call: `/api/queries/<query-name>/one?course_id=3`  
  SQL equivalent: `SELECT * FROM courses WHERE id = 3`  
- **omitFail**: If the query string does not contain a specific constraint value, this option omits the filter. In the example below, if `skill_id` and `material_id` are not provided, FluentCMS ignores these filters.

```json
{
  "filters": [
    {
      "fieldName": "id",
      "operator": "and",
      "omitFail": true,
      "constraints": [
        {
          "match": "in",
          "value": "qs.course_id"
        }
      ]
    },
    {
      "fieldName": "materials.id",
      "operator": "and",
      "omitFail": true,
      "constraints": [
        {
          "match": "in",
          "value": "qs.material_id"
        }
      ]
    },
    {
      "fieldName": "teacher.skills.id",
      "operator": "and",
      "omitFail": true,
      "constraints": [
        {
          "match": "in",
          "value": "qs.skill_id"
        }
      ]
    }
  ]
}
```

#### 6. Join
When sorting or filtering by related entities, FluentCMS joins the relevant tables. For example, with `course` as the main entity and a filter like `teacher.skills.id`, FluentCMS will join these tables:

```
FROM "courses"
LEFT JOIN "teachers" AS "teacher" ON "courses"."teacher" = "teacher"."id"
LEFT JOIN "skill_teacher" AS "skills_skill_teacher" ON "teacher"."id" = "teacher_skills_skill_teacher"."teacher_id"
LEFT JOIN "skills" AS "teacher_skills" ON "teacher_skills_skill_teacher"."skill_id" = "teacher_skills"."id"
```

### Query Endpoints

Each query has three corresponding endpoints:

- **List**: `/api/queries/<query-name>` retrieves a paginated list.
  - To view the next page: `/api/queries/<query-name>?last=***`
  - To view the previous page: `/api/queries/<query-name>?first=***`
`sorts` was applied when retrieving next page or previous page.
Example response:

```json
{
  "items": [],
  "first": "",
  "hasPrevious": false,
  "last": "eyJpZCI6M30",
  "hasNext": true
}
```

- **Single Record**: `/api/queries/<query-name>/one` returns the first record.
  - Example: `/api/queries/<query-name>/one?id=***`

- **Multiple Records**: `/api/queries/<query-name>/many` returns multiple records.
  - Example: `/api/queries/<query-name>/many?id=1&id=2&id=3`

If the number of IDs exceeds the page size, only the first set will be returned.

</details>